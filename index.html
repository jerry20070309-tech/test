import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client

# --- [1. é é¢è¦–è¦ºåŒ–é…ç½®] ---
st.set_page_config(page_title="SNIPER WHALE RADAR", layout="wide")
st.markdown("""
    <style>
    .main { background-color: #050505; }
    .stMetric { background-color: #0a0a0a; border: 1px solid #FFD700; padding: 15px; border-radius: 8px; }
    div[data-testid="stExpander"] { border: 1px solid #333; }
    </style>
    """, unsafe_allow_html=True)

# --- [2. å´é‚Šæ¬„ï¼šæœå°‹æ¬„èˆ‡æ ¸å¿ƒæ§åˆ¶] ---
with st.sidebar:
    st.title("âš¡ SNIPER V1.0")
    # åŠŸèƒ½ P1: æœå°‹æ¬„
    search_symbol = st.text_input("ğŸ” æœå°‹å¹£å° (å¦‚ BTCUSDT)", value="BTCUSDT").upper()
    whale_limit = st.number_input("ğŸ’° å·¨é¯¨å¤§å–®é–€æª» (USDT)", value=50000)
    
    st.divider()
    api_key = st.text_input("Binance API Key", type="password")
    api_secret = st.text_input("Binance API Secret", type="password")
    run_switch = st.toggle("å•Ÿå‹•é›·é”ç›£æ§")

# --- [3. æ ¸å¿ƒæŠ“å–é‚è¼¯ï¼šæ¯ 3 ç§’ 3 å°åŒ…] ---
def fetch_whale_packets(client, target):
    """
    å°é½Šç­–ç•¥ï¼šåœ¨åŒä¸€å€‹å¾ªç’°å…§æŠ“å– P2(æˆäº¤), P3(çˆ†å€‰), B2(æŒå€‰)
    """
    try:
        # å°åŒ… 1: P2 æˆäº¤æ•¸æ“š
        trades = client.futures_recent_trades(symbol=target, limit=30)
        # å°åŒ… 2: P3 çˆ†å€‰è¨‚å–®
        liquidations = client.futures_get_all_liquidation_orders(symbol=target, limit=5)
        # å°åŒ… 3: B2 æŒå€‰é‡åˆ†æ
        oi_data = client.futures_open_interest(symbol=target)
        return trades, liquidations, oi_data
    except Exception as e:
        return None, None, None

# --- [4. é‹ç®—èˆ‡æ¸²æŸ“å¼•æ“] ---
if run_switch and api_key and api_secret:
    client = Client(api_key, api_secret)
    ui_container = st.empty()
    
    # åˆå§‹åŒ–æŒä¹…åŒ–æ•¸æ“š (ç”¨æ–¼è¨ˆç®— OI è®ŠåŒ–)
    if 'prev_oi' not in st.session_state:
        st.session_state.prev_oi = 0.0
    if 'event_logs' not in st.session_state:
        st.session_state.event_logs = []

    while True:
        cycle_start = time.perf_counter()
        
        # åŸ·è¡Œæ•¸æ“šæŠ“å–
        trades, liqs, oi = fetch_whale_packets(client, search_symbol)

        if trades and oi:
            # æ•¸æ“šè§£æ
            price = float(trades[-1]['price'])
            curr_oi = float(oi['openInterest'])
            # è¨ˆç®— OI è®ŠåŒ–é‡ (B2 æ ¸å¿ƒ)
            oi_change = curr_oi - st.session_state.prev_oi if st.session_state.prev_oi > 0 else 0
            
            # ã€é€±å…­/é€±ä¸€ç­–ç•¥ã€‘æ­¸å±¬åˆ¤å®š
            # åš´æ ¼åŸ·è¡Œï¼šåƒ…ç•¶ UTC ç‚ºé€±å…­æ™‚æ¨™è¨»ï¼Œä¸è¨ˆå…¥å…¶ä»–å¤©æ•¸
            is_sat = datetime.utcnow().weekday() == 5
            
            with ui_container.container():
                st.markdown(f"### ğŸ¯ ç•¶å‰ç›£æ§ï¼š{search_symbol} " + ("ğŸŸ¢ [é€±å…­å°ˆå±¬æ¨¡å¼]" if is_sat else ""))
                
                # é ‚éƒ¨æŒ‡æ¨™å€ (P2 + B2)
                m1, m2, m3 = st.columns(3)
                m1.metric("å³æ™‚åƒ¹æ ¼", f"${price:,.2f}")
                m2.metric("æŒå€‰é‡ (B2)", f"{curr_oi:,.0f}", f"{oi_change:,.2f}")
                
                # è¨ˆç®—å¤§å–®é‡‘é¡ (P2)
                last_trade_vol = price * float(trades[-1]['qty'])
                m3.metric("æœ€æ–°æˆäº¤ (P2)", f"${last_trade_vol:,.0f}")

                # å·¨é¯¨å‡ºè²¨åˆ¤å®šé‚è¼¯
                st.divider()
                col_left, col_right = st.columns([2, 1])
                
                with col_left:
                    st.subheader("ğŸ•µï¸ å·¨é¯¨å‹•å‘è¿½è¹¤")
                    # é‚è¼¯ï¼šåƒ¹æ ¼æ¼² + OIè·Œ = å·¨é¯¨å¹³å€‰å‡ºè²¨
                    is_buyer_maker = trades[-1]['isBuyerMaker']
                    if last_trade_vol >= whale_limit:
                        status = "ğŸš¨ åµæ¸¬åˆ°å·¨é¯¨å¤§å–®"
                        if is_buyer_maker and oi_change < 0:
                            reason = "åˆ¤å®šï¼šã€å·¨é¯¨å¹³å€‰å‡ºè²¨ã€‘"
                            st.error(f"{status} | {reason}")
                        elif not is_buyer_maker and oi_change > 0:
                            reason = "åˆ¤å®šï¼šã€å·¨é¯¨é€²è²¨å»ºå€‰ã€‘"
                            st.success(f"{status} | {reason}")
                        else:
                            st.info(f"{status} | åˆ¤å®šï¼šå¸¸è¦æ›æ‰‹")
                    else:
                        st.write("ç›®å‰å¸‚å ´æ³¢å‹•ç©©å®šï¼Œå°šç„¡å·¨é¯¨ç•°å‹•ã€‚")

                with col_right:
                    st.subheader("ğŸ”¥ çˆ†å€‰ç›£æ§ (P3)")
                    if liqs:
                        for l in liqs:
                            st.warning(f"çˆ†å€‰åƒ¹æ ¼: {l['price']} | æ•¸é‡: {l['origQty']}")
                    else:
                        st.write("ç›®å‰ç„¡å¤§è¦æ¨¡çˆ†å€‰ã€‚")

            # æ›´æ–°ç·©å­˜
            st.session_state.prev_oi = curr_oi

        # åš´æ ¼åŸ·è¡Œ 3 ç§’å¾ªç’° (æ‰£é™¤ç¨‹å¼åŸ·è¡Œæ™‚é–“)
        elapsed = time.perf_counter() - cycle_start
        time.sleep(max(0, 3.0 - elapsed))
else:
    st.info("è«‹åœ¨å´é‚Šæ¬„è¼¸å…¥ API Key ä¸¦å•Ÿå‹•é›·é”ã€‚ç³»çµ±å°‡è‡ªå‹•åŸ·è¡Œæ¯ 3 ç§’ 3 å°åŒ…ç›£æ§ã€‚")
