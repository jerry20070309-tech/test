import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client
from binance.exceptions import BinanceAPIException

# --- [è¨­å®šå±¤] ---
st.set_page_config(page_title="Whale Tracker Pro", layout="wide")

# å´é‚Šæ¬„ï¼šæœå°‹èˆ‡é…ç½®
with st.sidebar:
    st.title("ðŸ‹ å·¨é¯¨ç›£æŽ§é¢æ¿")
    # ã€P1ã€‘æœå°‹æ¬„ï¼šå‹•æ…‹åˆ‡æ›ç›£æŽ§å¹£å°
    symbol = st.text_input("æœå°‹å¹£å° (ä¾‹å¦‚: BTCUSDT)", value="BTCUSDT").upper()
    whale_threshold = st.number_input("ã€P2ã€‘å·¨é¯¨æˆäº¤é–€æª» (USDT)", value=50000)
    api_key = st.text_input("è«‹è¼¸å…¥ API Key", type="password")
    api_secret = st.text_input("è«‹è¼¸å…¥ API Secret", type="password")
    is_active = st.toggle("å•Ÿå‹•ç›£æŽ§ç³»çµ±")

# --- [é‚è¼¯å±¤ï¼š3ç§’3å°åŒ…æŠ“å–] ---
def fetch_whale_data(client, symbol):
    """
    åº•å±¤é‚è¼¯ï¼š
    1. æŠ“å– P2 (æˆäº¤é‡)
    2. æŠ“å– P3 (çˆ†å€‰é‡)
    3. æŠ“å– B2 (æŒå€‰é‡åˆ†æž)
    """
    try:
        trades = client.futures_recent_trades(symbol=symbol, limit=20)
        oi = client.futures_open_interest(symbol=symbol)
        liq = client.futures_get_all_liquidation_orders(symbol=symbol, limit=5)
        return trades, oi, liq
    except Exception as e:
        st.error(f"é€£ç·šå¤±æ•—: {e}")
        return None, None, None

# --- [åŸ·è¡Œå±¤] ---
if is_active and api_key and api_secret:
    client = Client(api_key, api_secret)
    placeholder = st.empty()
    prev_oi = 0.0
    
    while True:
        start_loop = time.perf_counter()
        
        # åŸ·è¡Œ 3 å°åŒ…æŠ“å–
        trades, oi, liq = fetch_whale_data(client, symbol)
        
        if trades and oi:
            # è§£æžæ•¸æ“š
            df_trades = pd.DataFrame(trades)
            df_trades['price'] = df_trades['price'].astype(float)
            df_trades['qty'] = df_trades['qty'].astype(float)
            df_trades['total'] = df_trades['price'] * df_trades['qty']
            
            curr_oi = float(oi['openInterest'])
            oi_change = curr_oi - prev_oi if prev_oi != 0 else 0
            
            # ã€é€±å…­æ­¸å±¬é‚è¼¯ã€‘
            is_sat = datetime.utcnow().weekday() == 5
            
            with placeholder.container():
                st.header(f"ðŸ“Š {symbol} å³æ™‚çœ‹æ¿ " + ("(ðŸ“… é€±å…­ç›£æŽ§ä¸­)" if is_sat else ""))
                
                # æ•¸æ“šå„€è¡¨æ¿
                col1, col2, col3 = st.columns(3)
                col1.metric("åƒ¹æ ¼", f"${df_trades['price'].iloc[-1]:,.4f}")
                col2.metric("æŒå€‰è®Šå‹• (B2)", f"{curr_oi:,.2f}", f"{oi_change:,.2f}")
                col3.metric("æœ€æ–°æˆäº¤é¡ (P2)", f"${df_trades['total'].iloc[-1]:,.0f}")
                
                # åˆ¤å®šå·¨é¯¨æ˜¯å¦å‡ºè²¨
                st.divider()
                st.subheader("ðŸ•µï¸ å·¨é¯¨å‹•æ…‹åˆ†æž")
                
                # æª¢æŸ¥å¤§å–®
                big_trades = df_trades[df_trades['total'] >= whale_threshold]
                if not big_trades.empty:
                    for _, row in big_trades.iterrows():
                        side = "ðŸ”´ è³£å‡º" if row['isBuyerMaker'] else "ðŸŸ¢ è²·å…¥"
                        # åˆ¤å®šï¼šå¤§å–®è²·å…¥ + OIå¢žåŠ  = å»ºå€‰ï¼›å¤§å–®è³£å‡º + OIæ¸›å°‘ = å‡ºè²¨
                        if not row['isBuyerMaker'] and oi_change > 0:
                            note = "ðŸ’Ž å·¨é¯¨æ­£åœ¨é€²è²¨ (å»ºå€‰ä¸­)"
                        elif row['isBuyerMaker'] and oi_change < 0:
                            note = "âš ï¸ å·¨é¯¨æ­£åœ¨å‡ºè²¨ (ç²åˆ©äº†çµ)"
                        else:
                            note = "ðŸ”„ ç›¤æ•´æ›æ‰‹"
                        st.info(f"**åµæ¸¬åˆ°å¤§å–®:** {side} ${row['total']:,.0f} | **åˆ¤å®š:** {note}")

                # é¡¯ç¤ºçˆ†å€‰ (P3)
                if liq:
                    st.warning(f"ðŸš¨ åµæ¸¬åˆ°çˆ†å€‰æ´»å‹•ï¼åƒ¹æ ¼: {liq[0]['price']}")

            prev_oi = curr_oi

        # åš´æ ¼åŸ·è¡Œ 3 ç§’é€±æœŸ
        elapsed = time.perf_counter() - start_loop
        time.sleep(max(0, 3.0 - elapsed))
else:
    st.warning("è«‹åœ¨å´é‚Šæ¬„å¡«å¯« API Key ä¸¦é–‹å•Ÿã€Žå•Ÿå‹•ç›£æŽ§ç³»çµ±ã€ã€‚")
