import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client

# --- [A] å°ˆæ¥­é›·é”ä»‹é¢è¨­å®š ---
st.set_page_config(page_title="SNIPER WHALE V1.2", layout="wide")
st.markdown("""
    <style>
    .main { background-color: #050505; color: #FFD700; }
    .stMetric { border: 1px solid #FFD700; background-color: #0a0a0a; padding: 15px; border-radius: 10px; }
    </style>
    """, unsafe_allow_html=True)

# --- [B] æœå°‹èˆ‡æ§åˆ¶å€ ---
with st.sidebar:
    st.title("âš¡ SNIPER RADAR")
    # P1: æœå°‹åŠŸèƒ½ - é€™è£¡è¼¸å…¥å¹£å°ï¼Œç¶²é æœƒç«‹å³åæ‡‰
    target_symbol = st.text_input("ğŸ” æœå°‹ç›£æ§å¹£å°", value="BTCUSDT").upper()
    whale_threshold = st.number_input("ğŸ’µ å·¨é¯¨é–€æª» (USDT)", value=50000)
    
    st.divider()
    api_key = st.text_input("ğŸ”‘ API Key", type="password")
    api_secret = st.text_input("ğŸ”‘ API Secret", type="password")
    is_active = st.toggle("ğŸš€ å•Ÿå‹•ç›£æ§å¼•æ“")

# --- [C] æ ¸å¿ƒæŠ“å–é‚è¼¯ï¼šæ¯ 3 ç§’ 3 å°åŒ… ---
def fetch_packets(client, symbol):
    try:
        # åŒæ­¥å–å¾— P2(æˆäº¤)ã€B2(æŒå€‰)ã€P3(çˆ†å€‰)
        trades = client.futures_recent_trades(symbol=symbol, limit=20)
        oi = client.futures_open_interest(symbol=symbol)
        liqs = client.futures_get_all_liquidation_orders(symbol=symbol, limit=1)
        return trades, oi, liqs
    except:
        return None, None, None

# --- [D] åŸ·è¡Œé‚è¼¯ ---
if is_active and api_key and api_secret:
    client = Client(api_key, api_secret)
    placeholder = st.empty()
    if 'last_oi' not in st.session_state: st.session_state.last_oi = 0.0

    while True:
        loop_start = time.perf_counter()
        t, o, l = fetch_packets(client, target_symbol)

        if t and o:
            curr_price = float(t[-1]['price'])
            curr_oi = float(o['openInterest'])
            oi_change = curr_oi - st.session_state.last_oi if st.session_state.last_oi > 0 else 0
            
            # ã€é€±å…­/é€±ä¸€é‚è¼¯ã€‘åˆ¤å®š
            is_sat = datetime.utcnow().weekday() == 5
            
            with placeholder.container():
                st.header(f"ğŸ›°ï¸ {target_symbol} å¯¦æ™‚æˆ°å ± " + ("ğŸŸ¢ (é€±å…­æ¨¡å¼)" if is_
