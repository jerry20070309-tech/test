import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client
from binance.exceptions import BinanceAPIException

# --- [A1] ç¶²é ç‰ˆé ­èˆ‡ç’°å¢ƒåˆå§‹åŒ– ---
st.set_page_config(page_title="Binance Whale Dashboard", layout="wide")

# åˆå§‹åŒ– Session State (ç¢ºä¿è·¨ç§’æ•¸æ“šä¸ä¸Ÿå¤±)
if 'prev_oi' not in st.session_state:
    st.session_state.prev_oi = 0.0

# --- [A2] å´é‚Šæ¬„ï¼šæœå°‹èˆ‡å®‰å…¨æ€§è¨­å®š ---
with st.sidebar:
    st.title("ğŸ” ç›£æ§é…ç½®")
    # ã€P1ã€‘æœå°‹æ¬„ï¼šå‹•æ…‹æ±ºå®šç›£æ§å¹£å°
    symbol = st.text_input("æœå°‹å¹£å° (ä¾‹å¦‚ BTCUSDT)", value="BTCUSDT").upper()
    whale_threshold = st.number_input("ã€P2ã€‘å·¨é¯¨æˆäº¤é–€æª» (USDT)", value=50000)
    
    # å»ºè­°å¾ GitHub Secrets è®€å–ï¼Œæˆ–åœ¨æ­¤æ‰‹å‹•è¼¸å…¥
    api_key = st.text_input("Binance API Key", type="password")
    api_secret = st.text_input("Binance API Secret", type="password")
    
    is_active = st.toggle("ğŸš€ å•Ÿå‹•ç›£æ§ç³»çµ±")

# --- [A3] æ ¸å¿ƒæŠ“å–å‡½æ•¸ï¼šæ¯ 3 ç§’ 3 å°åŒ… ---
def fetch_binance_data(client, symbol):
    try:
        # åŒæ™‚è«‹æ±‚ï¼šæˆäº¤ (P2)ã€çˆ†å€‰ (P3)ã€æŒå€‰ (B2)
        trades = client.futures_recent_trades(symbol=symbol, limit=20)
        oi_data = client.futures_open_interest(symbol=symbol)
        liquidations = client.futures_get_all_liquidation_orders(symbol=symbol, limit=5)
        return trades, oi_data, liquidations
    except Exception as e:
        st.error(f"é€£ç·šç•°å¸¸: {e}")
        return None, None, None

# --- [A4] åŸ·è¡Œä¸»å¾ªç’° ---
if is_active and api_key and api_secret:
    # åƒ…åœ¨æŒ‰ä¸‹é–‹é—œå¾Œåˆå§‹åŒ– Clientï¼Œé¿å…é–‹é ­å ±éŒ¯
    client = Client(api_key, api_secret)
    placeholder = st.empty()

    while True:
        start_time = time.perf_counter() # ç²¾ç¢ºè¨ˆæ™‚é–‹å§‹
        
        trades, oi, liq = fetch_binance_data(client, symbol)

        if trades and oi:
            # æ•¸æ“šè§£æ
            df_trades = pd.DataFrame(trades)
            df_trades['price'] = df_trades['price'].astype(float)
            df_trades['qty'] = df_trades['qty'].astype(float)
            df_trades['total'] = df_trades['price'] * df_trades['qty']
            
            curr_oi = float(oi['openInterest'])
            oi_change = curr_oi - st.session_state.prev_oi if st.session_state.prev_oi != 0 else 0
            
            # ã€é€±å…­/é€±ä¸€æ­¸å±¬é‚è¼¯ã€‘
            is_saturday = datetime.utcnow().weekday() == 5
            
            with placeholder.container():
                st.markdown(f"## ğŸ“Š {symbol} å¯¦æ™‚åˆ†æçœ‹æ¿ " + ("ğŸŸ¢ (é€±å…­ç›£æ§)" if is_saturday else ""))
                
                # æ•¸æ“šå„€è¡¨æ¿
                c1, c2, c3 = st.columns(3)
                c1.metric("ç•¶å‰åƒ¹æ ¼", f"${df_trades['price'].iloc[-1]:,.4f}")
                c2.metric("æŒå€‰è®Šå‹• (B2)", f"{curr_oi:,.2f}", f"{oi_change:,.2f}")
                c3.metric("æœ€æ–°å¤§å–® (P2)", f"${df_trades['total'].iloc[-1]:,.0f}")

                st.divider()
                st.subheader("ğŸ•µï¸ å·¨é¯¨é€²å‡ºè²¨è‡ªå‹•åˆ¤å®š")
                
                # åˆ¤å®šé‚è¼¯ï¼šç¯©é¸å‡ºå¤§å–®
                big_trades = df_trades[df_trades['total'] >= whale_threshold]
                if not big_trades.empty:
                    for _, row in big_trades.iterrows():
                        side = "ğŸ”´ ä¸»å‹•è³£å‡º" if row['isBuyerMaker'] else "ğŸŸ¢ ä¸»å‹•è²·å…¥"
                        
                        # æ ¸å¿ƒå‡ºè²¨åˆ¤å®šï¼šåƒ¹æ ¼åœ¨æ¼²ï¼Œä½†æŒå€‰(OI)åœ¨æ¸›å°‘ = èŠå®¶è·‘è·¯
                        if not row['isBuyerMaker'] and oi_change > 0:
                            status = "ğŸ’ å·¨é¯¨é€²è²¨ä¸­ (å»ºå€‰æŒæœ‰)"
                        elif row['isBuyerMaker'] and oi_change < 0:
                            status = "âš ï¸ è­¦å‘Šï¼šå·¨é¯¨æ­£åœ¨å‡ºè²¨ (ç²åˆ©äº†çµ)"
                        else:
                            status = "ğŸ”„ å¸‚å ´æ›æ‰‹/å¸¸è¦æ³¢å‹•"
                        
                        st.info(f"**åµæ¸¬åˆ°å¤§å–®:** {side} ${row['total']:,.0f} | **åˆ¤å®š:** {status}")

                if liq:
                    st.warning(f"ğŸš¨ åµæ¸¬åˆ°çˆ†å€‰æ´»å‹•ï¼åƒ¹æ ¼: {liq[0]['price']}")

            # æ›´æ–°æ­·å²æŒå€‰
            st.session_state.prev_oi = curr_oi

        # ç¢ºä¿åš´æ ¼ 3 ç§’å¾ªç’°ï¼Œæ‰£é™¤ç¨‹å¼åŸ·è¡Œæ™‚é–“
        elapsed = time.perf_counter() - start_time
        time.sleep(max(0, 3.0 - elapsed))
else:
    st.info("ğŸ’¡ è«‹åœ¨å´é‚Šæ¬„è¼¸å…¥ API é‡‘é‘°ä¸¦å•Ÿå‹•ç›£æ§ã€‚å¦‚æœé‚„æ˜¯è·‘ä¸å‡ºä¾†ï¼Œè«‹æª¢æŸ¥ API Key æ˜¯å¦æœ‰é–‹é€š Futures æ¬Šé™ã€‚")
