import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client
from binance.exceptions import BinanceAPIException

# --- [è¨­å®šå±¤] ---
st.set_page_config(page_title="Whale Tracker Pro", layout="wide")

# å´é‚Šæ¬„ï¼šæœå°‹èˆ‡é…ç½®
with st.sidebar:
    st.title("ğŸ‹ å·¨é¯¨ç›£æ§é¢æ¿")
    symbol = st.text_input("ã€P1ã€‘æœå°‹å¹£å° (éœ€åŠ USDT)", value="BTCUSDT").upper()
    whale_threshold = st.number_input("ã€P2ã€‘å·¨é¯¨é–€æª» (USDT)", value=50000)
    api_key = st.text_input("API Key", type="password")
    api_secret = st.text_input("API Secret", type="password")
    is_active = st.toggle("å•Ÿå‹•å³æ™‚ç›£æ§")

# --- [é‚è¼¯å±¤ï¼šæ•¸æ“šç²å–] ---
def get_binance_data(client, symbol):
    """æ¯3ç§’ç™¼é€çš„3å¤§æ•¸æ“šå°åŒ…"""
    try:
        # å°åŒ… 1: ç²å–æœ€æ–°æˆäº¤ (P2)
        trades = client.futures_recent_trades(symbol=symbol, limit=20)
        # å°åŒ… 2: ç²å–æŒå€‰é‡ (B2)
        oi_data = client.futures_open_interest(symbol=symbol)
        # å°åŒ… 3: ç²å–æœ€è¿‘çˆ†å€‰ (P3)
        liquidations = client.futures_get_all_liquidation_orders(symbol=symbol, limit=5)
        
        return trades, oi_data, liquidations
    except BinanceAPIException as e:
        st.error(f"API éŒ¯èª¤: {e.message}")
        return None, None, None

# --- [åŸ·è¡Œå±¤] ---
if is_active and api_key and api_secret:
    client = Client(api_key, api_secret)
    placeholder = st.empty()
    
    # æ­·å²è¿½è¹¤è®Šæ•¸
    prev_oi = 0.0
    
    while True:
        start_time = time.perf_counter()
        
        trades, oi, liq = get_binance_data(client, symbol)
        
        if trades and oi:
            # 1. è™•ç† P2 (æˆäº¤é‡)
            df_trades = pd.DataFrame(trades)
            df_trades['price'] = df_trades['price'].astype(float)
            df_trades['qty'] = df_trades['qty'].astype(float)
            df_trades['total'] = df_trades['price'] * df_trades['qty']
            
            latest_trade = df_trades.iloc[-1]
            current_price = latest_trade['price']
            
            # 2. è™•ç† B2 (æŒå€‰é‡)
            current_oi = float(oi['openInterest'])
            oi_change = current_oi - prev_oi if prev_oi != 0 else 0
            
            # 3. åˆ¤æ–·æ™‚é–“æ­¸å±¬ (é€±å…­é‚è¼¯)
            is_saturday = datetime.utcnow().weekday() == 5
            
            # --- å‰ç«¯æ¸²æŸ“ ---
            with placeholder.container():
                st.markdown(f"## ğŸ“Š {symbol} å³æ™‚ç›£æ§ " + ("(ğŸ“… é€±å…­å°ˆå±¬æ¨¡å¼)" if is_saturday else ""))
                
                m1, m2, m3 = st.columns(3)
                m1.metric("ç•¶å‰åƒ¹æ ¼", f"${current_price:,.4f}")
                m2.metric("æŒå€‰é‡ (B2)", f"{current_oi:,.2f}", f"{oi_change:,.2f}")
                m3.metric("æœ€æ–°æˆäº¤é¡ (P2)", f"${latest_trade['total']:,.2f}")
                
                # --- å·¨é¯¨å‡ºè²¨åˆ¤å®šæ ¸å¿ƒ ---
                st.write("---")
                st.subheader("ğŸ•µï¸ å·¨é¯¨è¡Œç‚ºåµæ¸¬")
                
                # ç¯©é¸å‡ºå¤§é¡æˆäº¤
                big_trades = df_trades[df_trades['total'] >= whale_threshold]
                
                if not big_trades.empty:
                    for _, row in big_trades.iterrows():
                        direction = "ğŸ”´ ä¸»å‹•è³£å‡º" if row['isBuyerMaker'] else "ğŸŸ¢ ä¸»å‹•è²·å…¥"
                        
                        # æ ¸å¿ƒåˆ¤å®šé‚è¼¯
                        if not row['isBuyerMaker'] and oi_change > 0:
                            analysis = "ğŸ’ å·¨é¯¨é€²è²¨ï¼šå¤§å–®è²·å…¥ä¸”æŒå€‰å¢åŠ ï¼Œçœ‹æ¼²æƒ…ç·’å¼·ã€‚"
                        elif row['isBuyerMaker'] and oi_change < 0:
                            analysis = "âš ï¸ å·¨é¯¨å‡ºè²¨ï¼šå¤§å–®è³£å‡ºä¸”æŒå€‰æ¸›å°‘ï¼ŒèŠå®¶æ’¤é›¢ï¼"
                        else:
                            analysis = "ğŸ”„ æ›æ‰‹æ“ä½œï¼šå¸‚å ´éœ‡ç›ªä¸­ã€‚"
                        
                        st.info(f"**åµæ¸¬åˆ°å¤§å–®ï¼š** {direction} ${row['total']:,.2f} | **åˆ†æï¼š** {analysis}")
                else:
                    st.write("æš«ç„¡é”æ¨™å¤§å–®æˆäº¤...")

                # 4. è™•ç† P3 (çˆ†å€‰)
                if liq:
                    st.warning(f"ğŸš¨ åµæ¸¬åˆ°çˆ†å€‰æ´»å‹•ï¼æœ€è¿‘ä¸€ç­†åƒ¹æ ¼: {liq[0]['price']}")

            prev_oi = current_oi
            
        # ç¢ºä¿åš´æ ¼ 3 ç§’å¾ªç’°
        elapsed = time.perf_counter() - start_time
        sleep_time = max(0, 3.0 - elapsed)
        time.sleep(sleep_time)
else:
    st.info("è«‹åœ¨å´é‚Šæ¬„è¼¸å…¥ API Key ä¸¦å•Ÿå‹•ç›£æ§ã€‚")
