import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client

# è¨­å®šå€
st.set_page_config(page_title="Whale Tracker v1.0", layout="wide")

# æœå°‹æ¬„æ•´åˆ
with st.sidebar:
    st.title("ğŸ” åƒæ•¸è¨­å®š")
    symbol = st.text_input("è¼¸å…¥å¹£å° (ä¾‹å¦‚ BTCUSDT)", "BTCUSDT").upper()
    threshold = st.number_input("å·¨é¯¨æˆäº¤é–€æª» (USDT)", 50000)
    api_key = st.text_input("Binance API Key", type="password")
    api_secret = st.text_input("Binance API Secret", type="password")
    run = st.toggle("å•Ÿå‹•ç›£æ§")

# æ ¸å¿ƒè¨ˆç®—é‚è¼¯ (B2 + P2)
def fetch_data():
    client = Client(api_key, api_secret)
    
    # å°åŒ… 1 & 2: æˆäº¤èˆ‡æŒå€‰ (P2 + B2)
    trades = client.futures_recent_trades(symbol=symbol, limit=5)
    oi = client.futures_open_interest(symbol=symbol)
    
    # å°åŒ… 3: çˆ†å€‰ (P3)
    liq = client.futures_get_all_liquidation_orders(symbol=symbol, limit=5)
    
    return trades, oi, liq

if run and api_key and api_secret:
    placeholder = st.empty()
    last_oi = 0
    
    while True:
        try:
            trades, oi, liq = fetch_data()
            curr_oi = float(oi['openInterest'])
            price = float(trades[-1]['price'])
            qty = float(trades[-1]['qty'])
            vol = price * qty
            
            # åˆ¤æ–·é€±å…­æ­¸å±¬
            is_sat = datetime.utcnow().weekday() == 5
            
            with placeholder.container():
                st.write(f"### æ­£åœ¨ç›£æ§: {symbol} " + ("(ğŸ“… é€±å…­æ¨¡å¼)" if is_sat else ""))
                
                c1, c2, c3 = st.columns(3)
                c1.metric("ç•¶å‰åƒ¹æ ¼", f"${price}")
                c2.metric("æŒå€‰é‡ (B2)", f"{curr_oi:,.2f}", f"{curr_oi - last_oi:,.2f}")
                c3.metric("æœ€æ–°æˆäº¤é¡ (P2)", f"${vol:,.0f}")
                
                # åˆ¤å®šå·¨é¯¨æ˜¯å¦å‡ºè²¨
                if vol > threshold:
                    if curr_oi < last_oi:
                        st.error("ğŸš¨ è­¦å‘Šï¼šå·¨é¯¨å¤§é¡æˆäº¤ä½†æŒå€‰æ¸›å°‘ -> ã€æ­£åœ¨å‡ºè²¨/å¹³å€‰ã€‘")
                    else:
                        st.success("âœ… ç¢ºèªï¼šå·¨é¯¨å¤§é¡æˆäº¤ä¸”æŒå€‰å¢åŠ  -> ã€å»ºå€‰æŒæœ‰ä¸­ã€‘")
                
                if liq:
                    st.warning(f"ğŸ”¥ åµæ¸¬åˆ°è¿‘æœŸçˆ†å€‰äº‹ä»¶")

            last_oi = curr_oi
            time.sleep(3) # åš´æ ¼åŸ·è¡Œæ‚¨çš„ 3 ç§’å°åŒ…é‚è¼¯
            
        except Exception as e:
            st.error(f"ç™¼ç”ŸéŒ¯èª¤: {e}")
            break
else:
    st.info("è«‹è¼¸å…¥ API Key ä¸¦é»æ“Šå•Ÿå‹•ç›£æ§")
