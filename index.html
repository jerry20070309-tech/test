import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client
import sqlite3

# --- 1. åˆå§‹åŒ–èˆ‡ä»£è™Ÿå®šç¾© ---
# P1: å¹£å°æ¸…å–® / P2: å¤§é¡æˆäº¤ / P3: çˆ†å€‰é‡ / B2: æŒå€‰åˆ†æ
st.set_page_config(page_title="Binance Whale Tracker", layout="wide")
st.title("ğŸ‹ å·¨é¯¨è¿½è¹¤å„€ (Whale & OI Tracker)")

# è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ API Key (åƒ…è®€å–æ¬Šé™å³å¯)
# å»ºè­°ä½¿ç”¨ streamlit secrets æˆ–ç’°å¢ƒè®Šæ•¸
API_KEY = ""
API_SECRET = ""
client = Client(API_KEY, API_SECRET)

# åˆå§‹åŒ–æ•¸æ“šåº« (ç”¨æ–¼é€±å…­æ•¸æ“šæ­¸å±¬)
def init_db():
    conn = sqlite3.connect('whale_data.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS saturday_trades
                 (timestamp TEXT, symbol TEXT, price REAL, amount REAL, oi REAL, type TEXT)''')
    conn.commit()
    return conn

# --- 2. æ ¸å¿ƒé‚è¼¯å±¤ï¼šåˆ¤æ–·é€²å‡ºè²¨ ---
def analyze_whale_behavior(prev_oi, curr_oi, trade_type):
    """
    åº•å±¤é‚è¼¯ï¼š
    - OIä¸Šå‡ + ä¸»å‹•è²·å…¥ = å·¨é¯¨é€²è²¨å»ºå€‰
    - OIä¸‹é™ + ä¸»å‹•è²·å…¥ = ç©ºé ­çˆ†å€‰/å¹³å€‰
    """
    if curr_oi > prev_oi:
        return "ğŸ”¥ å·¨é¯¨å»ºå€‰ (æŒæœ‰ä¸­)" if trade_type == "BUY" else "âš ï¸ å·¨é¯¨é–‹ç©º"
    else:
        return "æ”¶å‰²å®Œæˆ (æ­£åœ¨å‡ºè²¨/å¹³å€‰)"

# --- 3. å‰ç«¯ä»‹é¢ï¼šæœå°‹æ¬„èˆ‡ç›£æ§é…ç½® ---
with st.sidebar:
    st.header("ğŸ” ç›£æ§é…ç½®")
    target_symbol = st.text_input("è¼¸å…¥ç›£æ§å¹£å° (ä¾‹å¦‚: BTCUSDT)", value="BTCUSDT").upper()
    whale_threshold = st.number_input("å·¨é¯¨æˆäº¤é–€æª» (USDT)", value=50000)
    monitor_switch = st.button("é–‹å§‹ç›£æ§")

# --- 4. åŸ·è¡Œå¾ªç’°ï¼šæ¯ 3 ç§’ç™¼é€ 3 å°åŒ… ---
if monitor_switch:
    placeholder = st.empty()
    prev_oi = 0
    conn = init_db()

    while True:
        try:
            # --- å°åŒ… 1: æŠ“å–å¸‚å ´æˆäº¤é‡ (P2) ---
            trades = client.futures_recent_trades(symbol=target_symbol, limit=10)
            df_trades = pd.DataFrame(trades)
            # è¨ˆç®—æœ€æ–°ä¸€ç­†å¤§å–®
            last_price = float(df_trades['price'].iloc[-1])
            last_qty = float(df_trades['qty'].iloc[-1])
            last_value = last_price * last_qty
            is_buyer_maker = df_trades['isBuyerMaker'].iloc[-1]
            trade_dir = "SELL" if is_buyer_maker else "BUY"

            # --- å°åŒ… 2: æŠ“å–æŒå€‰é‡ (B2) ---
            oi_data = client.futures_open_interest(symbol=target_symbol)
            curr_oi = float(oi_data['openInterest'])

            # --- å°åŒ… 3: æŠ“å–çˆ†å€‰æ•¸æ“š (P3 - æ¨¡æ“¬æŠ“å–æœ€æ–°å¼·å¹³) ---
            # è¨»ï¼šå®Œæ•´ P3 å»ºè­°ä¸²æ¥ WebSocketï¼Œæ­¤è™•ä»¥ API ç²å–æœ€æ–°ç‹€æ…‹
            liq_data = client.futures_get_all_liquidation_orders(symbol=target_symbol, limit=1)
            
            # --- æ™‚é–“è™•ç†ï¼šé€±å…­æ­¸å±¬é‚è¼¯ ---
            now = datetime.now()
            is_saturday = (now.weekday() == 5) # 5 ä»£è¡¨é€±å…­
            
            if is_saturday and last_value >= whale_threshold:
                # å°‡é€±å…­çš„å¤§é¡æ•¸æ“šå­˜å…¥è³‡æ–™åº«
                c = conn.cursor()
                c.execute("INSERT INTO saturday_trades VALUES (?,?,?,?,?,?)", 
                          (now.isoformat(), target_symbol, last_price, last_value, curr_oi, trade_dir))
                conn.commit()

            # --- è¡Œç‚ºåˆ¤æ–· ---
            status = analyze_whale_behavior(prev_oi, curr_oi, trade_dir)
            
            # --- å„€è¡¨æ¿é¡¯ç¤º ---
            with placeholder.container():
                col1, col2, col3 = st.columns(3)
                col1.metric("ç•¶å‰åƒ¹æ ¼", f"${last_price}")
                col2.metric("æŒå€‰é‡ (OI)", f"{curr_oi}", f"{curr_oi - prev_oi:.2f}")
                col3.metric("æœ€è¿‘æˆäº¤é¡", f"${last_value:,.2f}")

                st.subheader(f"ğŸ“Š å·¨é¯¨è¡Œç‚ºåˆ†æï¼š{status}")
                if is_saturday:
                    st.warning("ğŸ“… ç•¶å‰æ•¸æ“šå·²è‡ªå‹•æ­¸é¡ç‚ºã€é€±å…­å°ˆå±¬æ•¸æ“šã€‘")

                # é¡¯ç¤ºæœ€è¿‘çˆ†å€‰ç´€éŒ„
                if liq_data:
                    st.error(f"ğŸš¨ åµæ¸¬åˆ°çˆ†å€‰å–®ï¼šåƒ¹æ ¼ {liq_data[0]['price']} æ•¸é‡ {liq_data[0]['origQty']}")

            prev_oi = curr_oi
            time.sleep(3) # æ¯ 3 ç§’å¾ªç’°ä¸€æ¬¡

        except Exception as e:
            st.error(f"é€£ç·šéŒ¯èª¤: {e}")
            break
