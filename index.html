import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client

# --- 1. UI æ¨£å¼é…ç½® (åƒè€ƒ Sniper é»‘è‰²é»ƒé‡‘é¢¨æ ¼) ---
st.set_page_config(page_title="SNIPER WHALE V1.0", layout="wide")
st.markdown("""
    <style>
    .main { background-color: #050505; color: #FFD700; }
    .stMetric { background-color: #0a0a0a; border: 1px solid #1a1a1a; padding: 10px; border-radius: 5px; }
    .whale-log { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. å´é‚Šæ¬„èˆ‡æœå°‹åŠŸèƒ½ ---
with st.sidebar:
    st.title("âš¡ SNIPER CONTROL")
    # ã€P1ã€‘æœå°‹åŠŸèƒ½ï¼šå‹•æ…‹åˆ‡æ›å¹£å°
    symbol = st.text_input("æœå°‹å¹£å° (ä¾‹å¦‚ BTCUSDT)", value="BTCUSDT").upper()
    whale_threshold = st.number_input("å·¨é¯¨é–€æª» (USDT)", value=50000)
    
    st.divider()
    api_key = st.text_input("API Key", type="password")
    api_secret = st.text_input("API Secret", type="password")
    start_radar = st.toggle("START RADAR")

# --- 3. æ ¸å¿ƒæŠ“å–é‚è¼¯ï¼šæ¯ 3 ç§’ 3 å°åŒ… ---
def get_data_packets(client, target):
    try:
        # å°åŒ… A: å¤§é¡æˆäº¤ (P2)
        trades = client.futures_recent_trades(symbol=target, limit=20)
        # å°åŒ… B: çˆ†å€‰ç›£æ§ (P3)
        liquidations = client.futures_get_all_liquidation_orders(symbol=target, limit=1)
        # å°åŒ… C: æŒå€‰åˆ†æ (B2)
        oi_data = client.futures_open_interest(symbol=target)
        return trades, liquidations, oi_data
    except Exception as e:
        st.error(f"é€£ç·šä¸­æ–·: {e}")
        return None, None, None

# --- 4. åŸ·è¡Œå¼•æ“ ---
if start_radar and api_key and api_secret:
    client = Client(api_key, api_secret)
    placeholder = st.empty()
    
    # åˆå§‹åŒ–æ­·å²æ•¸æ“šï¼ˆç”¨æ–¼ B2 æŒå€‰å°æ¯”ï¼‰
    if 'last_oi' not in st.session_state:
        st.session_state.last_oi = 0.0
    if 'log' not in st.session_state:
        st.session_state.log = []

    while True:
        start_loop = time.perf_counter()
        
        # åŸ·è¡Œæ¯ 3 ç§’çš„ 3 å°åŒ…ä»»å‹™
        trades, liq, oi = get_data_packets(client, symbol)
        
        if trades and oi:
            # æ•¸æ“šè™•ç†
            curr_price = float(trades[-1]['price'])
            curr_oi = float(oi['openInterest'])
            oi_change = curr_oi - st.session_state.last_oi if st.session_state.last_oi > 0 else 0
            
            # ã€é€±å…­æ­¸å±¬åˆ¤å®šã€‘
            is_saturday = datetime.utcnow().weekday() == 5
            
            # å·¨é¯¨è¡Œç‚ºåˆ¤å®š (åƒè€ƒ Sniper è©•åˆ†é‚è¼¯ä½†å°ˆæ³¨æ–¼å‡ºè²¨)
            last_trade_val = float(trades[-1]['price']) * float(trades[-1]['qty'])
            is_buyer_maker = trades[-1]['isBuyerMaker']
            
            analysis = "ğŸ”„ æ›æ‰‹"
            if last_trade_val >= whale_threshold:
                if not is_buyer_maker and oi_change > 0:
                    analysis = "ğŸ’ å·¨é¯¨é€²è²¨ (HOLDING)"
                elif is_buyer_maker and oi_change < 0:
                    analysis = "âš ï¸ å·¨é¯¨å‡ºè²¨ (EXITING)"
                
                # å¯«å…¥æˆ°é¬¥æ—¥èªŒ
                log_entry = f"[{datetime.now().strftime('%H:%M:%S')}] {symbol} | ${last_trade_val:,.0f} | {analysis}"
                st.session_state.log.insert(0, log_entry)

            # --- ç•«é¢æ¸²æŸ“ ---
            with placeholder.container():
                st.title(f"âš¡ {symbol} RADAR " + ("(SATURDAY MODE)" if is_saturday else ""))
                
                # é ‚éƒ¨æŒ‡æ¨™å€
                c1, c2, c3 = st.columns(3)
                c1.metric("PRICE", f"${curr_price:,.2f}")
                c2.metric("OI (B2)", f"{curr_oi:,.2f}", f"{oi_change:,.2f}")
                c3.metric("LAST TRADE (P2)", f"${last_trade_val:,.0f}")
                
                # ä¸­é–“æ—¥èªŒå€èˆ‡çˆ†å€‰è­¦å ±
                col_left, col_right = st.columns([2, 1])
                with col_left:
                    st.subheader("æˆ°é¬¥æ—¥èªŒ (Whale Logs)")
                    st.code("\n".join(st.session_state.log[:10]), language="bash")
                
                with col_right:
                    st.subheader("ç•°å¸¸ç‹€æ…‹")
                    if liq:
                        st.error(f"ğŸ”¥ P3 çˆ†å€‰åµæ¸¬\nåƒ¹æ ¼: {liq[0]['price']}")
                    if abs(oi_change) > (curr_oi * 0.01):
                        st.warning("âš ï¸ OI åŠ‡çƒˆæ³¢å‹•")

            st.session_state.last_oi = curr_oi

        # åš´æ ¼æ§åˆ¶ 3 ç§’å¾ªç’°
        elapsed = time.perf_counter() - start_loop
        time.sleep(max(0, 3.0 - elapsed))
else:
    st.warning("è«‹é…ç½® API Key ä¸¦æŒ‰ä¸‹ START RADAR å•Ÿå‹•æƒæã€‚")
